(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function l(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(t){if(t.ep)return;t.ep=!0;const a=l(t);fetch(t.href,a)}})();const B={};B.show=function(){if(!B.el){const e=document.querySelector(".popup-wrapper"),r=document.querySelector(".popup-wrapper__body"),l=e.querySelector("button.modify"),n=e.querySelector("button.delete"),t=e.querySelector("button.copy");e.addEventListener("click",function(){B.hide()}),l.onclick=function(a){a.preventDefault();const o=this.parentElement.previousElementSibling.value,u=Number(this.parentElement.previousElementSibling.dataset.index);tasks.splice(u,1,JSON.parse(o)),syncLocal(),B.hide(),redrawChart(!0)},n.onclick=function(a){a.preventDefault();const o=Number(this.parentElement.previousElementSibling.dataset.index);confirm("Are you sure to DELETE the task?")&&(tasks.splice(o,1),syncLocal()),B.hide(),redrawChart(!0)},t.onclick=function(a){a.preventDefault();const o=Number(this.parentElement.previousElementSibling.dataset.index),u={...tasks[o],duration:1};tasks.splice(o+1,0,u),console.log(tasks[o]),syncLocal(),B.hide(),redrawChart(!0)},r.onclick=function(a){a.stopPropagation()},B.el=e}B.el.style.display="flex"};B.hide=function(){B.el.style.display="none"};function st(e,r,l){if(e&&e.length){const[n,t]=r,a=Math.PI/180*l,o=Math.cos(a),u=Math.sin(a);for(const y of e){const[s,i]=y;y[0]=(s-n)*o-(i-t)*u+n,y[1]=(s-n)*u+(i-t)*o+t}}}function vt(e,r,l){const n=[];e.forEach(t=>n.push(...t)),st(n,r,l)}function kt(e,r){return e[0]===r[0]&&e[1]===r[1]}function ht(e,r,l,n=1){const t=l,a=Math.max(r,.1),o=e[0]&&e[0][0]&&typeof e[0][0]=="number"?[e]:e,u=[0,0];if(t)for(const s of o)st(s,u,t);const y=bt(o,a,n);if(t){for(const s of o)st(s,u,-t);vt(y,u,-t)}return y}function bt(e,r,l){const n=[];for(const s of e){const i=[...s];kt(i[0],i[i.length-1])||i.push([i[0][0],i[0][1]]),i.length>2&&n.push(i)}const t=[];r=Math.max(r,.1);const a=[];for(const s of n)for(let i=0;i<s.length-1;i++){const h=s[i],S=s[i+1];if(h[1]!==S[1]){const H=Math.min(h[1],S[1]);a.push({ymin:H,ymax:Math.max(h[1],S[1]),x:H===h[1]?h[0]:S[0],islope:(S[0]-h[0])/(S[1]-h[1])})}}if(a.sort((s,i)=>s.ymin<i.ymin?-1:s.ymin>i.ymin?1:s.x<i.x?-1:s.x>i.x?1:s.ymax===i.ymax?0:(s.ymax-i.ymax)/Math.abs(s.ymax-i.ymax)),!a.length)return t;let o=[],u=a[0].ymin,y=0;for(;o.length||a.length;){if(a.length){let s=-1;for(let h=0;h<a.length&&!(a[h].ymin>u);h++)s=h;a.splice(0,s+1).forEach(h=>{o.push({s:u,edge:h})})}if(o=o.filter(s=>!(s.edge.ymax<=u)),o.sort((s,i)=>s.edge.x===i.edge.x?0:(s.edge.x-i.edge.x)/Math.abs(s.edge.x-i.edge.x)),(l!==1||y%r===0)&&o.length>1)for(let s=0;s<o.length;s=s+2){const i=s+1;if(i>=o.length)break;const h=o[s].edge,S=o[i].edge;t.push([[Math.round(h.x),u],[Math.round(S.x),u]])}u+=l,o.forEach(s=>{s.edge.x=s.edge.x+l*s.edge.islope}),y++}return t}window.hachureLines=ht;const ut={"01-01":{holiday:!0,name:"元旦",wage:3,date:"2024-01-01",rest:1},"02-04":{holiday:!1,name:"春节前补班",wage:1,after:!1,target:"春节",date:"2024-02-04",rest:34},"02-10":{holiday:!0,name:"初一",wage:3,date:"2024-02-10",rest:40},"02-11":{holiday:!0,name:"初二",wage:3,date:"2024-02-11"},"02-12":{holiday:!0,name:"初三",wage:3,date:"2024-02-12"},"02-13":{holiday:!0,name:"初四",wage:2,date:"2024-02-13"},"02-14":{holiday:!0,name:"初五",wage:2,date:"2024-02-14"},"02-15":{holiday:!0,name:"初六",wage:2,date:"2024-02-15"},"02-16":{holiday:!0,name:"初七",wage:2,date:"2024-02-16"},"02-17":{holiday:!0,name:"初八",wage:2,date:"2024-02-17"},"02-18":{holiday:!1,name:"春节后补班",wage:1,after:!0,target:"春节",date:"2024-02-18"},"04-04":{holiday:!0,name:"清明节",wage:3,date:"2024-04-04",rest:46},"04-05":{holiday:!0,name:"清明节",wage:2,date:"2024-04-05"},"04-06":{holiday:!0,name:"清明节",wage:2,date:"2024-04-06"},"04-07":{holiday:!1,name:"清明节后补班",wage:1,target:"清明节",after:!0,date:"2024-04-07"},"04-28":{holiday:!1,name:"劳动节前补班",wage:1,target:"劳动节",after:!1,date:"2024-04-28"},"05-01":{holiday:!0,name:"劳动节",wage:3,date:"2024-05-01"},"05-02":{holiday:!0,name:"劳动节",wage:2,date:"2024-05-02"},"05-03":{holiday:!0,name:"劳动节",wage:3,date:"2024-05-03"},"05-04":{holiday:!0,name:"劳动节",wage:3,date:"2024-05-04"},"05-05":{holiday:!0,name:"劳动节",wage:3,date:"2024-05-05"},"05-11":{holiday:!1,name:"劳动节后补班",after:!0,wage:1,target:"劳动节",date:"2024-05-11"},"06-08":{holiday:!0,name:"端午节",wage:2,date:"2024-06-08"},"06-09":{holiday:!0,name:"端午节",wage:2,date:"2024-06-09"},"06-10":{holiday:!0,name:"端午节",wage:3,date:"2024-06-10"},"09-14":{holiday:!1,name:"中秋节前补班",after:!1,wage:1,target:"中秋节",date:"2024-09-14"},"09-15":{holiday:!0,name:"中秋节",wage:2,date:"2024-09-15"},"09-16":{holiday:!0,name:"中秋节",wage:2,date:"2024-09-16"},"09-17":{holiday:!0,name:"中秋节",wage:3,date:"2024-09-17"},"09-29":{holiday:!1,name:"国庆节前补班",after:!1,wage:1,target:"国庆节",date:"2024-09-29"},"10-01":{holiday:!0,name:"国庆节",wage:3,date:"2024-10-01"},"10-02":{holiday:!0,name:"国庆节",wage:3,date:"2024-10-02",rest:1},"10-03":{holiday:!0,name:"国庆节",wage:3,date:"2024-10-03"},"10-04":{holiday:!0,name:"国庆节",wage:2,date:"2024-10-04"},"10-05":{holiday:!0,name:"国庆节",wage:2,date:"2024-10-05"},"10-06":{holiday:!0,name:"国庆节",wage:2,date:"2024-10-06",rest:1},"10-07":{holiday:!0,name:"国庆节",wage:2,date:"2024-10-07",rest:1},"10-12":{holiday:!1,after:!0,wage:1,name:"国庆节后补班",target:"国庆节",date:"2024-10-12"}};function gt(e){const r=new Date(e),l=r.getMonth()+1+"",n=l.padStart(2,"0"),t=r.getDate()+"",a=t.padStart(2,"0"),o=`${n}-${a}`,u=[0,6].indexOf(r.getDay())!=-1;return ut[o]?{isHoliday:ut[o].holiday,dateString:`${l}-${t}`}:{isHoliday:u,dateString:`${l}-${t}`}}let P=null;const _=e=>{P=e},nt=v("debug")??!1,Lt="alexq",c=v()??160,q=c/2,Z=v("taskNamePaddingLeft")??15,Mt=1,Tt=50,b=v("timeScaleHeight")??20,G=v("milestoneTopHeight")??20,g=v("barHeight")??30,x=nt?10:v("barMargin")??1,Et=v("scrollSpeed")??35,Rt=v("includeHoliday")??!1,it=v("useLocal"),ft=v("useRemote"),tt=v("view",!1)??"",Bt=!ft&&!it&&v("mockTaskSize")?Number(v("mockTaskSize")):0,mt=Math.floor((+new Date-+new Date("2024-01-01"))/(60*60*24*1e3)),yt=document.querySelector("#last-scroll-x");function v(e="unitWidth",r=!0){const l=new URLSearchParams(location.search);return l.get(e)&&r?Number(l.get(e)):l.get(e)}function $(){Xt()||v("useLocal")&&Object.keys(et).forEach(e=>{const r=localStorage.getItem(e);try{localStorage.setItem(e,JSON.stringify(window[e]))}catch{console.error("fail to syncLocal"),localStorage.setItem(e,r)}})}window.syncLocal=$;let rt=null;function Xt(){if(v("useRemote")){const e={tasks:window.tasks,mileStones:window.mileStones};return rt&&clearTimeout(rt),rt=setTimeout(()=>{pt(e).then(r=>{console.log("recordUpdate",r)})},200),!0}return!1}const wt=localStorage.getItem("remoteHost")?localStorage.getItem("remoteHost"):"http://localhost:3004";function pt(e){return fetch(`${wt}/record/add`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({view:tt,...e})})}function Ct(){return console.log("current view",tt),fetch(`${wt}/record/query${tt?`?view=${tt}`:""}`).then(e=>e.json())}const et={tasks:[{}],mileStones:[]};function xt(e="tasks"){try{return localStorage.getItem(e)?JSON.parse(localStorage.getItem(e)):et[e]}catch{return console.error("fail to getLocal"),et[e]}}function F(){const e=Math.floor(Math.random()*256),r=Math.floor(Math.random()*256),l=Math.floor(Math.random()*256);return"#"+e.toString(16).padStart(2,"0")+r.toString(16).padStart(2,"0")+l.toString(16).padStart(2,"0")}function Ht(e,r){e.dom.hidden=!0,Ct().then(l=>{const{data:n}=l;console.log(n),window.tasks.length=0,window.mileStones.length=0,n!=null&&n.tasks||n!=null&&n.mileStones?(window.tasks.push(...n.tasks),window.mileStones.push(...n.mileStones)):n||window.tasks.push({}),r(!0),e.dom.hidden=!1})}function Dt(e){const r=e?{view:`${e}`}:{};pt({tasks:window.tasks,mileStones:window.mileStones,...r})}window.saveToRemote=Dt;function $t(e){Object.keys(et).forEach(r=>{const l=localStorage.getItem(r);try{localStorage.setItem(r,JSON.stringify(window[r]))}catch{console.error("fail to syncLocal"),localStorage.setItem(r,l)}})}window.saveToLocal=$t;function Nt(e,r,l,n){const t=document.querySelector("#back-to-origin-button");t==null||t.addEventListener("click",function(){l.innerText=0,n(!0)});const a=document.querySelector("#clear-button");a==null||a.addEventListener("click",function(){const u=tasks.length;tasks.length=0;for(let y=0;y<u;y++)tasks.push({});$(),n(!0)});const o=document.querySelector("#clear-milestone-button");o==null||o.addEventListener("click",function(){mileStones.length=0,$(),n(!0)})}function Pt(){return zrender.path.createFromString("M3.333,10v 5 c0,0.184 -0.149, 0.333 -0.333, 0.333 h-0.667A0.333, 0.333 0 0 1 2, 15 V 1.333 c0, -0.368 0.298, -0.666 0.667, -0.666 h 11.525 a 0.667, 0.667 0 0 1 0.581, 0.994 L 12.76, 5.233 a 0.333, 0.333 0 0 0 0.002, 0.33 L 14.753, 9 A 0.667, 0.667 0 0 1 14.176, 10 H 3.333z",{style:{fill:"#F54A45"}})}function It(e,r,l,n,t){const a=new zrender.Group,o=Pt(),{width:u,height:y}=o.getBoundingRect();o.attr({x:r+l-u/2,y:n-t+t/2-y/2});const s=new zrender.Circle({shape:{cx:r+l+1,cy:n-t+t/2,r:12},style:{fill:"rgba(211, 211, 211, 0.5)"}});return a.add(s),a.add(o),a.hide(),e.add(a),[a,{flag:o,flagHoveredCircle:s}]}function Ot(e,r,l,n){const{height:t,width:a}=l,o=new zrender.Rect({name:"leftBar",style:{fill:`rgba(0, 255, 0, ${nt?1:0})`,lineWidth:1},shape:{width:e,height:t},draggable:"horizontal",cursor:"ew-resize",z:1});o.attr({x:r.x,y:r.y,shape:{x:-e/2,y:0}});let u=0,y=0,s=0;return o.on("dragstart",function(i){this.parent.resizing=!0,u=i.event.zrX;const h=this.taskBar;s=h.shape.width,y=h.shape.x,_(this.parent)}),o.on("drag",function(i){const h=i.event.zrX-u;this.taskBar.attr({shape:{x:y+h,width:s-h}})}),o.on("dragend",function(i){const h=i.event.zrX-u,S=h<0?-1:1,H=Math.abs(h),A=H%c,N=S*(Math.floor(H/c)+Math.floor(A/q));console.log(N);const j=tasks[this.parent.index];j.start+=N,j.duration-=N,N&&$(),_(null),n(!0)}),o}function Wt(e,r,l,n){const{height:t,width:a}=l,o=new zrender.Rect({style:{fill:`rgba(255, 192, 203, ${nt?1:0})`,lineWidth:1},shape:{width:e,height:t},draggable:"horizontal",cursor:"ew-resize",z:1});o.attr({x:r.x+a,y:r.y,shape:{x:-e/2,y:0}});let u=0,y=0;return o.on("dragstart",function(s){this.parent.resizing=!0,u=s.event.zrX;const i=this.taskBar;y=i.shape.width,i.shape.x,console.log(P),_(this.parent)}),o.on("drag",function(s){const i=s.event.zrX-u;this.taskBar.attr({shape:{width:y+i}})}),o.on("dragend",function(s){const i=s.event.zrX-u,h=i<0?-1:1,S=Math.abs(i),H=S%c,A=h*(Math.floor(S/c)+Math.floor(H/q)),N=tasks[this.parent.index];N.duration+=A,A&&$(),_(null),n(!0)}),o}const qt=+new Date("2024-01-01"),At=60*60*24*1e3;function Ft(e,r){const{start:l,duration:n}=e;if(r)return e.duration;let t=0;const a=n+l;for(let o=l;o<a;o++)gt(new Date(qt+At*o)).isHoliday||t++;return t}function _t(e,r,l,n,t,a,o){const u=new zrender.Rect({shape:{x:r+o*c-1+q,y:l,width:2,height:tasks.length*(t+a)},style:{fill:"#2955c9"},z:1}),y=new zrender.Circle({shape:{cx:r+o*c+q,cy:l-n+n+2,r:3},style:{fill:"#2955c9"}});e.add(u),e.add(y)}let at=null,C=0+(mt-1)*c,jt=0;const w=zrender.init(document.getElementById("zrender-container"),{renderer:"canvas"});ft&&(document.title+=" (Remote)",Ht(w,X));const z=it?xt():[{name:"Task 1",start:0,duration:3,resource:"John",fillColor:F()},{name:"Task 2",start:2,duration:4,resource:"Jane",fillColor:F()},{name:"Task 3 long long long",start:7,duration:1,resource:"Bob",fillColor:F()},{name:"Task 4",start:8,duration:2,resource:"Bose",fillColor:F()},{name:"Task 5",start:10,duration:8,resource:"Uno",fillColor:F()},{}];for(;z.length>1&&z.length<Bt;){const e=z.pop();z.push(...z,e)}window.tasks=z;const Y=it?xt("mileStones"):[{start:10,name:"提测"}];window.mileStones=Y;w.on("mousewheel",function(e){e.event.preventDefault(),C-=Math.floor(e.event.wheelDeltaX*.01*Et),X(!0,C,0),yt.innerText=C});window.addEventListener("resize",function(){w.resize(),X(!0)});Nt(C,jt,yt,X);function X(e,r=C,l=0){const n=Mt-r,t=Math.max(Tt,b+G)-l;e&&w.clear();const a=w.getWidth(),o=w.getHeight(),u=Math.floor(C/c),y=Math.floor((C+a)/c);let s,i;function h(d){if(P!=null&&P.resizing||P!=null&&P.dragging)return;const k=d.event.zrX-n,L=d.event.zrY-t,p=Math.floor(k/c),f=Math.floor(L/(g+x));if(s!==[p,f].join())if(s=[p,f].join(),f>=0&&f<z.length){if(p>=z[f].start&&p<z[f].start+z[f].duration){i&&w.remove(i);return}const m=new zrender.Group;m.on("click",function(){console.log("dayHoverGroup clicked pos: ",[p,f]);const O=prompt("task name?");if(!O)return;const W=prompt("assign to who?")||Lt;z.splice(f,0,{name:O,start:p,duration:1,resource:W,fillColor:F()}),$(),X(!0)});const M=new zrender.Rect({shape:{x:n+c*p+5,y:t+(g+x)*f,width:c-10,height:g+x},style:{fill:"transparent",stroke:"gray",lineDash:[5,7]},z:100}),T=new zrender.Rect({shape:{x:n+C,y:t+(g+x)*f,width:c*S,height:g+x},style:{fill:"rgba(221, 221, 221, 0.3)"},z:1}),I=new zrender.Line({shape:{x1:n+c*p+c/2-5,y1:t+(g+x)*f+(g+x)/2,x2:n+c*p+c/2+5,y2:t+(g+x)*f+(g+x)/2},style:{stroke:"gray"},z:100}),J=new zrender.Line({shape:{x1:n+c*p+c/2,y1:t+(g+x)*f+(g+x)/2-5,x2:n+c*p+c/2,y2:t+(g+x)*f+(g+x)/2+5},style:{stroke:"gray"},z:100});m.add(M),m.add(I),m.add(J),m.add(T),i&&w.remove(i),i=m,w.add(m)}else i&&w.remove(i)}at&&w.off("mousemove",at),at=h,w.on("mousemove",h);const S=Math.ceil(a/c),H=new zrender.Rect({shape:{x:n+C,y:t-b,width:S*c,height:b},style:{fill:"rgba(255, 0,0, .2)"}});w.add(H);const A=n,N=S*c,j=S+1,St=Math.floor(C/c);for(let d=0+St,k=0;k<j;d++,k++){const L=Math.min(z.length,(o-t)/(g+x)),p=A+d*c,f=new zrender.Line({shape:{x1:p,y1:t-b,x2:p,y2:t+(g+x)*L},style:{stroke:"lightgray"}});if(k<j-1){const m=+new Date("2024-01-01")+d*60*1e3*60*24,M=gt(m);if(M.isHoliday)try{ht([[n+d*c,t],[n+d*c+c,t],[n+d*c+c,t+(g+x)*L],[n+d*c,t+(g+x)*L]],10,45).forEach(D=>{const[V,K]=D[0],[R,Q]=D[1],ot=new zrender.Line({shape:{x1:V,y1:K,x2:R,y2:Q},style:{stroke:"rgba(221, 221, 221, 0.7)"}});w.add(ot)})}catch(E){console.log(E)}const T=new zrender.Text({style:{text:M.dateString,x:p,y:t-b},z:1}),[I,{flag:J}]=It(w,p,q,t,b);T.on("click",function(){console.log("date text click",d);const E=Y.findIndex(D=>D.start===d);if(E===-1){if(confirm("Do you want to CREATE a milestone here?")){const D=prompt("mileStone name?");Y.push({start:d,name:D}),$()}}else confirm("Do you want to DELETE the milestone here?")&&(Y.splice(E,1),$());X(!0)}),T.on("mouseover",function(E){this.attr({style:{opacity:0}}),I.show()}),T.on("mouseout",function(E){this.attr({style:{opacity:1}}),I.hide()});const{width:O,height:W}=T.getBoundingRect();T.attr({style:{x:p-O/2+q,y:t-b-W/2+b/2}}),w.add(T)}w.add(f)}z.length+1;for(let d=0;d<1;d++){const k=t+d*(g+x),L=new zrender.Line({shape:{x1:n,y1:k,x2:N+n,y2:k},style:{stroke:"lightgray"}});w.add(L)}_t(w,n,t,b,g,x,mt),Y.forEach(function(d){const k=new zrender.Rect({shape:{x:n+d.start*c-1,y:t-b,width:2,height:z.length*(g+x)+b},style:{fill:"rgba(255, 0, 0, 1)"},z:1}),L=new zrender.Rect({shape:{x:n+d.start*c-1,y:t-b-G,width:10,height:G},style:{fill:"rgba(255, 0, 0, 1)"},z:1}),p=new zrender.Text({style:{x:n+d.start*c-1+10,y:t-b-G,text:d.name||"里程碑",fill:"white",lineHeight:G,fontSize:12},z:1}),f=p.getBoundingRect();L.attr({shape:{width:f.width+10*2}}),w.add(k),w.add(L),w.add(p)});let lt=0;z.forEach(function(d,k){if(!(d!=null&&d.name)||k>Math.floor((o-t)/(g+x))||d.start>y||d.start+d.duration<u)return;lt++;const L=n+d.start*c,p=t+(g+x)*k,f=d.duration*c,U={width:f,height:g},m=new zrender.Group({x:L,y:p,draggable:"horizontal"}),M=new zrender.Rect({shape:{x:0,y:0,width:f,height:g,r:6},style:{fill:d.fillColor},cursor:"move"});m.add(M),m.index=k;const T=6,I=M.getBoundingRect(),J=Ot(T,I,U,X);J.taskBar=M,m.add(J);const O=Wt(T,I,U,X);O.taskBar=M,m.add(O),m.on("mouseover",function(){this.dragging||M.attr("style",{fill:zrender.color.lift(d.fillColor,.3)})}),m.on("mouseout",function(){this.dragging||this.resizing||M.attr("style",{fill:d.fillColor})});const W=new zrender.Text({style:{text:d.name,x:Z,y:g/2-12/2,textFill:"white",textAlign:"left",textVerticalAlign:"middle",fill:"white"},cursor:"move"}),E=new zrender.Text({style:{text:`${Ft(d,Rt)}天`,x:f-Z,y:g/2-12/2,textFill:"white",textAlign:"left",textVerticalAlign:"middle",fill:"white"},cursor:"move"}),{width:D}=E.getBoundingRect();E.attr({style:{x:f-D-Z}});const V=new zrender.Text({style:{text:"Assigned to: "+d.resource,x:0+f+5,y:g/2+0-12/2,textFill:"black"},cursor:"normal"});W.getBoundingRect().width+D+Z*2>f&&(V.attr({style:{text:d.name}}),W.hide()),m.add(W),m.add(E),m.add(V);let K=0;m.on("dragstart",function(R){this.resizing||(K=R.event.zrX,_(this))}),m.on("drag",function(R){this.resizing}),m.on("dragend",function(R){if(console.log("dragend"),this.resizing){this.resizing=!1;return}const Q=R.event.zrX-K,ot=Q<0?-1:1,ct=Math.abs(Q),zt=ct%c,dt=ot*(Math.floor(ct/c)+Math.floor(zt/q));d.start+=dt,dt&&$(),_(null),X(!0)}),m.eachChild(function(R){R.attr({z:10})}),m.on("dblclick",function(){B.show();const R=document.querySelector("#current-task");R.value=JSON.stringify(z[this.index],null,2),R.dataset.index=this.index}),w.add(m)}),nt&&console.log({drawTaskBar:lt})}window.redrawChart=X;X();
